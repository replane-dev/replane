name: Benchmark Tests

on:
  workflow_call:
    outputs:
      results:
        description: 'Benchmark results from k6'
        value: ${{ jobs.bench.outputs.results }}
  workflow_dispatch:

env:
  REPLANE_SUPERADMIN_API_KEY: 'test-superadmin-api-key-for-bench'
  REPLANE_ADMIN_URL: http://localhost:8091
  REPLANE_EDGE_URL: http://localhost:8091

jobs:
  bench:
    name: Benchmark Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      results: ${{ steps.benchmark.outputs.results }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Build Docker image
        run: docker compose -f bench/docker-compose.yml build

      - name: Start services
        run: docker compose -f bench/docker-compose.yml up -d --wait postgres replane prometheus

      - name: Run benchmark tests
        id: benchmark
        run: |
          # Run benchmark and capture output
          pnpm bench 2>&1 | tee benchmark-output.txt

          # Extract the results section (from THRESHOLDS to the end)
          {
            echo "results<<EOF"
            sed -n '/â–ˆ THRESHOLDS/,$ p' benchmark-output.txt | head -200
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Show logs on failure
        if: failure()
        run: docker compose -f bench/docker-compose.yml logs

      - name: Cleanup
        if: always()
        run: docker compose -f bench/docker-compose.yml down -v
