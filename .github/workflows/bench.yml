name: Benchmark Tests

on:
  workflow_call:
    inputs:
      test_duration:
        description: 'Test duration (e.g., 2m, 1h)'
        required: false
        type: string
        default: '2m'
      sse_vus:
        description: 'Number of SSE virtual users'
        required: false
        type: number
        default: 4000
      admin_vus:
        description: 'Number of Admin API virtual users'
        required: false
        type: number
        default: 5
      timeout_minutes:
        description: 'Job timeout in minutes'
        required: false
        type: number
        default: 20
    outputs:
      results:
        description: 'Benchmark results from k6'
        value: ${{ jobs.bench.outputs.results }}
  workflow_dispatch:
    inputs:
      test_duration:
        description: 'Test duration (e.g., 2m, 1h)'
        required: false
        type: string
        default: '2m'
      sse_vus:
        description: 'Number of SSE virtual users'
        required: false
        type: number
        default: 4000
      admin_vus:
        description: 'Number of Admin API virtual users'
        required: false
        type: number
        default: 5

env:
  REPLANE_SUPERADMIN_API_KEY: 'test-superadmin-api-key-for-bench'
  REPLANE_ADMIN_URL: http://localhost:8091
  REPLANE_EDGE_URL: http://localhost:8091

jobs:
  bench:
    name: Benchmark Tests
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout_minutes || 20 }}
    outputs:
      results: ${{ steps.benchmark.outputs.results }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Build Docker image
        run: docker compose -f bench/docker-compose.yml build

      - name: Start services
        run: docker compose -f bench/docker-compose.yml up -d --wait postgres replane prometheus

      - name: Run benchmark tests
        id: benchmark
        env:
          TEST_DURATION: ${{ inputs.test_duration || '2m' }}
          SSE_VUS: ${{ inputs.sse_vus || 1000 }}
          ADMIN_VUS: ${{ inputs.admin_vus || 5 }}
          RAMP_DOWN_TIME: '5s'
          PROJECTS_COUNT: '100'
          ADMIN_REQUEST_DELAY_MS: '100'
          SSE_DURATION_MS: '30000'
        run: |
          set -o pipefail

          echo "Running benchmark with:"
          echo "  Duration: $TEST_DURATION"
          echo "  SSE VUs: $SSE_VUS"
          echo "  Admin VUs: $ADMIN_VUS"

          # Run benchmark and capture output
          # k6 exits with non-zero if thresholds fail, pipefail ensures we catch it
          k6 run --out experimental-prometheus-rw bench/scripts/spec.ts 2>&1 | tee benchmark-output.txt
          K6_EXIT_CODE=${PIPESTATUS[0]}

          # Extract the results section (from THRESHOLDS to the end)
          {
            echo "results<<EOF"
            sed -n '/█ THRESHOLDS/,$ p' benchmark-output.txt | head -200
            echo "EOF"
          } >> $GITHUB_OUTPUT

          # Exit with k6's exit code to fail the job if thresholds crossed
          exit $K6_EXIT_CODE

      - name: Benchmark Results
        if: always()
        run: |
          echo "═══════════════════════════════════════════════════════════════"
          echo "                      BENCHMARK RESULTS                        "
          echo "═══════════════════════════════════════════════════════════════"
          echo ""
          echo "Configuration:"
          echo "  Duration:   ${{ inputs.test_duration || '2m' }}"
          echo "  SSE VUs:    ${{ inputs.sse_vus || 1000 }}"
          echo "  Admin VUs:  ${{ inputs.admin_vus || 5 }}"
          echo ""
          echo "───────────────────────────────────────────────────────────────"
          echo ""
          if [ -f benchmark-output.txt ]; then
            cat benchmark-output.txt
          else
            echo "No benchmark output available"
          fi
          echo ""
          echo "═══════════════════════════════════════════════════════════════"

          # Also write to job summary for GitHub UI
          echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Duration | ${{ inputs.test_duration || '2m' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SSE VUs | ${{ inputs.sse_vus || 1000 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Admin VUs | ${{ inputs.admin_vus || 5 }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if [ -f benchmark-output.txt ]; then
            sed -n '/█ THRESHOLDS/,$ p' benchmark-output.txt | head -200 >> $GITHUB_STEP_SUMMARY
          else
            echo "No benchmark output available" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Show logs on failure
        if: failure()
        run: docker compose -f bench/docker-compose.yml logs

      - name: Cleanup
        if: always()
        run: docker compose -f bench/docker-compose.yml down -v
